# .github/workflows/ci-deploy.yml
# CI/CD workflow for deployments to main branch
#
# Required secrets for deployment:
#   - VERCEL_TOKEN: Vercel authentication token for deployment
#   - VERCEL_ORG_ID: Vercel organization ID
#   - VERCEL_PROJECT_ID: Vercel project ID
#
# Optional secrets:
#   - SONAR_TOKEN: SonarCloud authentication token (for code quality analysis)
#   - SONAR_PROJECT_KEY: SonarCloud project key
#   - SONAR_ORGANIZATION: SonarCloud organization name

name: CI/CD - Deploy on main

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      # Checkout source code with full git history
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Run linting checks
      - name: Lint
        run: npm run lint

      # Run tests (placeholder for now, to be implemented by test owner)
      - name: Run tests (placeholder)
        run: |
          echo "Placeholder for tests - to be implemented by test owner"
          # Future implementation:
          # npm run test -- --coverage --watchAll=false --ci --passWithNoTests
          # or: npm test -- --coverage --ci

      # Build React TypeScript project
      - name: Build
        run: npm run build

  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build-and-test
    # Only deploy if build-and-test job succeeded
    if: needs.build-and-test.result == 'success'
    steps:
      # Checkout source code
      - name: Checkout
        uses: actions/checkout@v4

      # Set up Node.js for Vercel CLI
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Deploy to Vercel using CLI
      - name: Deploy to Vercel
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' }}
        run: |
          npm install -g vercel@latest
          echo "Deploying to Vercel..."
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
          echo "Deployment completed successfully"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      # Alternative: Deploy using Vercel GitHub integration (simpler approach)
      # If you have Vercel connected to your GitHub repo, deployment happens automatically
      # In that case, this job can just verify the build was successful
      - name: Deployment status
        if: always()
        run: |
          status="${{ job.status }}"
          if [ "$status" == "success" ]; then
            echo "Deployment completed successfully"
          else
            echo "Deployment finished with status: ${status}"
          fi
