# .github/workflows/ci-pr.yml
# CI workflow for Pull Requests targeting main branch
# 
# Required secrets:
#   - SONAR_TOKEN: SonarCloud authentication token
#   - SONAR_PROJECT_KEY: SonarCloud project key
#   - SONAR_ORGANIZATION: SonarCloud organization name
#
# Optional secrets:
#   - SONARQUBE_HOST: SonarQube server URL (if using self-hosted SonarQube)
#   - SONARQUBE_TOKEN: SonarQube authentication token (if using self-hosted SonarQube)

name: CI - Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest
    steps:
      # Checkout source code with full git history (required for SonarCloud)
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install dependencies
      - name: Install dependencies
        if: hashFiles('package-lock.json') != ''
        run: npm ci

      # Run ESLint for code quality
      - name: Run linter
        if: hashFiles('package.json') != ''
        run: npm run lint

      # Build React TypeScript project
      - name: Build project
        if: hashFiles('package.json') != ''
        run: npm run build

      # Run unit tests (placeholder for now)
      - name: Run unit tests (placeholder)
        if: hashFiles('package.json') != ''
        run: |
          echo "SKIP - tests to be added by test owner"
          # Future implementation:
          # npm run test -- --coverage --watchAll=false
          # or: npm test -- --coverage --ci --passWithNoTests

  sonarcloud-analysis:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [lint-and-build]
    # Only run SonarCloud analysis on Pull Requests targeting main and if package.json exists
    if: ${{ github.event_name == 'pull_request' && github.base_ref == 'main' }}
    steps:
      # Checkout source code with full git history (required for SonarCloud)
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Check if package.json exists
      - name: Check if Node.js project exists
        id: check_project
        run: |
          if [ -f "package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No package.json found - skipping SonarCloud analysis"
          fi

      # Set up Node.js environment
      - name: Setup Node.js
        if: steps.check_project.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install dependencies
      - name: Install dependencies
        if: steps.check_project.outputs.exists == 'true'
        run: npm ci

      # Run tests to generate coverage report (placeholder for now)
      - name: Run tests to generate coverage
        if: steps.check_project.outputs.exists == 'true'
        run: |
          echo "Placeholder for test coverage - to be implemented by test owner"
          # Future implementation:
          # npm run test -- --coverage --watchAll=false --coverageReporters=lcov
          # This should generate coverage/lcov.info file

      # Run SonarCloud scan
      - name: SonarCloud Scan
        if: steps.check_project.outputs.exists == 'true'
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          args: >-
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.sources=src
            -Dsonar.tests=src
            -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/coverage/**,**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx
            -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

